<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Area Precision Pro (Fixed Drift)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .accuracy-bar { transition: width 0.4s ease, background-color 0.4s ease; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .current-marker { animation: pulse-red 1s infinite; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 flex flex-col items-center">

    <div class="w-full max-w-md space-y-4">
        <div class="bg-gray-800 p-6 rounded-3xl shadow-2xl border border-gray-700">
            <h1 class="text-2xl font-bold text-blue-400 text-center mb-1">üõ∞Ô∏è GPS Precision Pro</h1>
            <p class="text-gray-400 text-[10px] text-center mb-4 uppercase tracking-widest">Advanced Filtering System</p>

            <div class="bg-black/40 p-4 rounded-2xl border border-gray-600 space-y-3">
                <div class="flex justify-between items-center">
                    <span id="status-display" class="font-bold text-red-400 text-sm">GPS ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</span>
                    <span id="accuracy-text" class="text-[10px] font-mono text-gray-400">Accuracy: -- m</span>
                </div>
                <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
                    <div id="accuracy-bar" class="accuracy-bar h-full w-0 bg-red-500"></div>
                </div>
                <div class="text-[11px] font-mono text-blue-300 text-center bg-blue-900/20 py-1 rounded" id="coords-display">
                    ‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏û‡∏¥‡∏Å‡∏±‡∏î...
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3 mt-4">
                <button id="toggle-gps" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95">‡πÄ‡∏õ‡∏¥‡∏î GPS</button>
                <button id="record-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg disabled:opacity-30 flex flex-col items-center justify-center" disabled>
                    <span>üìç ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î</span>
                    <span id="sampling-status" class="text-[9px] opacity-70 font-normal">‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥</span>
                </button>
            </div>
        </div>

        <div class="bg-gray-800 p-4 rounded-3xl shadow-xl border border-gray-700">
            <div class="relative bg-gray-950 rounded-2xl overflow-hidden border-2 border-gray-700 aspect-square">
                <canvas id="path-canvas" width="400" height="400" class="w-full h-full"></canvas>
                <div id="dist-tag" class="absolute top-2 right-2 bg-black/60 text-[10px] px-2 py-1 rounded text-yellow-400 border border-yellow-500/30">‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ: 0 m</div>
                <div class="absolute bottom-2 left-2 flex flex-col gap-1">
                    <span class="text-[9px] bg-black/60 px-2 py-0.5 rounded text-green-400">‚óè ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
                    <span class="text-[9px] bg-black/60 px-2 py-0.5 rounded text-red-500 current-marker">‚óè ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
                </div>
            </div>
            
            <div id="result-display" class="mt-4 p-4 bg-indigo-900/20 rounded-2xl border border-indigo-500/20 text-center min-h-[60px] flex items-center justify-center">
                <p class="text-gray-500 text-xs italic">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>
            </div>

            <div class="grid grid-cols-3 gap-2 mt-4">
                <button id="undo-btn" class="bg-gray-700 hover:bg-gray-600 text-white py-2 rounded-lg text-xs disabled:opacity-30">‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button id="calculate-btn" class="bg-purple-600 hover:bg-purple-500 text-white py-2 rounded-lg text-xs font-bold disabled:opacity-30 col-span-1" disabled>üìê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</button>
                <button id="clear-btn" class="bg-gray-700 hover:bg-red-900 text-white py-2 rounded-lg text-xs">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏û‡∏¥‡∏Å‡∏±‡∏î</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('path-canvas'), ctx = canvas.getContext('2d');
        let points = [], watchId = null, currentPos = null;
        let posHistory = []; // Buffer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ Smoothing

        function updateLocation(pos) {
            const acc = pos.coords.accuracy;
            const bar = document.getElementById('accuracy-bar');
            const status = document.getElementById('status-display');
            
            document.getElementById('accuracy-text').textContent = `Accuracy: ${acc.toFixed(1)} m`;
            let width = Math.max(5, 100 - (acc * 2.5));
            bar.style.width = `${width}%`;

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 20 ‡πÄ‡∏°‡∏ï‡∏£‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏¢‡∏≠‡∏°‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
            if (acc > 25) {
                status.textContent = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡πà‡∏≠‡∏ô/‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô';
                status.className = 'font-bold text-orange-500 text-sm';
                bar.className = 'accuracy-bar h-full bg-red-600';
                return;
            }

            // ‡∏£‡∏∞‡∏ö‡∏ö Smoothing (Moving Average) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ß‡∏π‡∏ö‡∏ß‡∏≤‡∏ö
            posHistory.push({lat: pos.coords.latitude, lon: pos.coords.longitude});
            if(posHistory.length > 5) posHistory.shift();
            
            const avgLat = posHistory.reduce((a,b) => a + b.lat, 0) / posHistory.length;
            const avgLon = posHistory.reduce((a,b) => a + b.lon, 0) / posHistory.length;

            currentPos = { lat: avgLat, lon: avgLon };
            
            status.textContent = acc < 10 ? '‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á' : '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
            status.className = acc < 10 ? 'font-bold text-emerald-400 text-sm' : 'font-bold text-yellow-400 text-sm';
            bar.className = acc < 10 ? 'accuracy-bar h-full bg-emerald-500' : 'accuracy-bar h-full bg-yellow-500';
            
            document.getElementById('coords-display').textContent = `Lat: ${avgLat.toFixed(6)}, Lon: ${avgLon.toFixed(6)}`;
            document.getElementById('record-btn').disabled = false;
            draw();
        }

        async function recordPoint() {
            if (!currentPos) return;
            const btn = document.getElementById('record-btn');
            const samplingText = document.getElementById('sampling-status');
            
            btn.disabled = true;
            samplingText.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î...";

            // Multi-sampling: ‡∏£‡∏≠‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ô‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 3 ‡∏£‡∏≠‡∏ö
            await new Promise(r => setTimeout(r, 600)); 
            
            points.push({...currentPos});
            if (window.navigator.vibrate) window.navigator.vibrate([40, 30, 40]); // ‡∏™‡∏±‡πà‡∏ô‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
            
            samplingText.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!";
            setTimeout(() => samplingText.textContent = "‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≠‡πÑ‡∏õ", 1500);
            btn.disabled = false;
            
            updateUI();
            draw();
        }

        function project(pts) {
            if (pts.length === 0) return [];
            const R = 6371000;
            // ‡πÉ‡∏ä‡πâ‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏Ç‡∏≠‡∏á‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á
            const lat0 = pts[0].lat * Math.PI / 180;
            const lon0 = pts[0].lon * Math.PI / 180;
            return pts.map(p => ({
                x: (p.lon * Math.PI / 180 - lon0) * R * Math.cos(lat0),
                y: (p.lat * Math.PI / 180 - lat0) * R
            }));
        }

        function draw(isCalculated = false) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let all = [...points];
            if(currentPos && !isCalculated) all.push(currentPos);
            const proj = project(all);
            if (proj.length === 0) return;

            const xs = proj.map(p => p.x), ys = proj.map(p => p.y);
            const minX = Math.min(...xs), maxX = Math.max(...xs), minY = Math.min(...ys), maxY = Math.max(...ys);
            const scale = Math.min(340 / (maxX - minX || 1), 340 / (maxY - minY || 1));

            ctx.save();
            ctx.translate(canvas.width/2 - ((minX+maxX)/2)*scale, canvas.height/2 + ((minY+maxY)/2)*scale);
            
            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô)
            ctx.beginPath();
            proj.forEach((p, i) => {
                if(i < points.length) i === 0 ? ctx.moveTo(p.x*scale, -p.y*scale) : ctx.lineTo(p.x*scale, -p.y*scale);
            });
            if (currentPos && points.length > 0 && !isCalculated) {
                const lastIdx = points.length - 1;
                ctx.lineTo(proj[proj.length-1].x*scale, -proj[proj.length-1].y*scale);
            }

            if(isCalculated) {
                ctx.closePath();
                ctx.fillStyle = 'rgba(99, 102, 241, 0.3)';
                ctx.fill();
                ctx.setLineDash([]);
            } else {
                ctx.setLineDash([5, 5]); // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ó‡∏≤‡∏á
            }
            ctx.strokeStyle = '#4f46e5'; ctx.lineWidth = 3; ctx.stroke();

            // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î
            proj.forEach((p, i) => {
                ctx.setLineDash([]);
                ctx.beginPath();
                const isCurrent = (i === all.length-1 && !isCalculated);
                ctx.arc(p.x*scale, -p.y*scale, isCurrent ? 6 : 4, 0, 7);
                if (i === 0) ctx.fillStyle = '#10b981'; // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                else if (isCurrent) ctx.fillStyle = '#ef4444'; // ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                else ctx.fillStyle = '#fbbf24'; // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                ctx.fill();
                ctx.strokeStyle = "white"; ctx.lineWidth = 1; ctx.stroke();
            });
            ctx.restore();
        }

        function calculate() {
            if (points.length < 3) return;
            const R = 6371000;
            let area = 0;
            for (let i = 0; i < points.length; i++) {
                let p1 = points[i], p2 = points[(i + 1) % points.length];
                let lat1 = p1.lat * Math.PI / 180, lat2 = p2.lat * Math.PI / 180;
                let lon1 = p1.lon * Math.PI / 180, lon2 = p2.lon * Math.PI / 180;
                area += (lon2 - lon1) * (2 + Math.sin(lat1) + Math.sin(lat2));
            }
            area = Math.abs(area * R * R / 2);
            const wa = area / 4;
            const rai = Math.floor(wa / 400), ngan = Math.floor((wa % 400) / 100), sqWa = (wa % 100).toFixed(1);

            document.getElementById('result-display').innerHTML = `
                <div class="animate-in fade-in">
                    <p class="text-2xl font-black text-emerald-400">${area.toLocaleString(undefined,{maximumFractionDigits:1})} <span class="text-[10px] text-white">‡∏ï‡∏£.‡∏°.</span></p>
                    <p class="text-blue-300 font-bold text-sm">${rai} ‡πÑ‡∏£‡πà ${ngan} ‡∏á‡∏≤‡∏ô ${sqWa} ‡∏ï‡∏£.‡∏ß.</p>
                </div>`;
            draw(true);
        }

        function getDist(p1, p2) {
            const R = 6371e3;
            const dLat = (p2.lat-p1.lat)*Math.PI/180, dLon = (p2.lon-p1.lon)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function updateUI() {
            document.getElementById('calculate-btn').disabled = points.length < 3;
            document.getElementById('undo-btn').disabled = points.length === 0;
            let totalDist = 0;
            for(let i=0; i<points.length-1; i++) totalDist += getDist(points[i], points[i+1]);
            if(points.length > 2) totalDist += getDist(points[points.length-1], points[0]);
            document.getElementById('dist-tag').textContent = `‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ: ${totalDist.toFixed(1)} m`;
        }

        document.getElementById('toggle-gps').onclick = function() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null; this.textContent = "‡πÄ‡∏õ‡∏¥‡∏î GPS"; this.className = "bg-blue-600 font-bold py-3 rounded-xl w-full transition-all";
                document.getElementById('status-display').textContent = '‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà';
            } else {
                this.textContent = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...";
                watchId = navigator.geolocation.watchPosition(updateLocation, (e)=>alert(e.message), {enableHighAccuracy:true, maximumAge:0});
                this.classList.replace('bg-blue-600', 'bg-red-600'); this.textContent = "‡∏õ‡∏¥‡∏î GPS";
            }
        };

        document.getElementById('record-btn').onclick = recordPoint;
        document.getElementById('calculate-btn').onclick = calculate;
        document.getElementById('undo-btn').onclick = () => { points.pop(); updateUI(); draw(); };
        document.getElementById('clear-btn').onclick = () => { if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) location.reload(); };
    </script>
</body>
</html>
