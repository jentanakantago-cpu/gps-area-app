<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartField Area Analytics (Pro Precision)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Inter:wght@400;600&display=swap');
        body { font-family: 'Kanit', 'Inter', sans-serif; }
        .font-mono-custom { font-family: 'Inter', monospace; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-gray-800 p-6 rounded-3xl shadow-2xl w-full max-w-md space-y-5 border border-gray-700">
        
        <div class="text-center">
            <h1 class="text-2xl font-bold text-blue-400">üõ∞Ô∏è Smart Field Area Analytics</h1>
            <p class="text-gray-400 text-sm"></p>
        </div>

        <div class="bg-gray-700/50 p-4 rounded-2xl border border-gray-600 space-y-2">
            <div class="flex justify-between items-center">
                <span class="font-semibold text-lg text-gray-200">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ GPS:</span>
                <span id="status-display" class="font-bold text-red-400 transition-colors">‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</span>
            </div>
            <div class="text-xs font-mono-custom text-gray-300 bg-black/30 p-2 rounded-lg" id="coords-display">
                Lat: --- , Lon: ---
            </div>
            <div class="text-xs text-yellow-400 font-semibold" id="accuracy-display">
                ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: --- ‡πÄ‡∏°‡∏ï‡∏£
            </div>
        </div>

        <div class="relative bg-gray-900 rounded-2xl overflow-hidden border-2 border-blue-500/30">
            <canvas id="path-canvas" width="400" height="300" class="w-full h-auto"></canvas>
            <div class="absolute bottom-2 left-2 flex gap-2">
                <span class="text-[10px] bg-black/50 px-2 py-1 rounded text-green-400">‚óè ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
                <span class="text-[10px] bg-black/50 px-2 py-1 rounded text-red-500 animate-pulse">‚óè ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
            </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button id="toggle-gps" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg transition-all active:scale-95">
                ‡πÄ‡∏õ‡∏¥‡∏î GPS
            </button>
            <button id="record-btn" class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg disabled:opacity-30 disabled:grayscale transition-all active:scale-95" disabled>
                üìç ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î
            </button>
        </div>

        <div class="bg-gray-700/30 p-3 rounded-xl">
            <p class="text-xs text-gray-400 mb-1">‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß: <span id="point-count" class="text-white font-bold">0</span></p>
            <div id="points-list" class="text-[10px] font-mono-custom text-gray-500 max-h-16 overflow-y-auto">
                ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </div>
        </div>

        <div id="result-display" class="bg-gradient-to-br from-indigo-900/40 to-blue-900/40 p-5 rounded-2xl border border-blue-500/30 text-center min-h-[80px] flex items-center justify-center">
            <p class="text-gray-500 text-sm italic">‡∏Å‡∏î‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà</p>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <button id="calculate-btn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-3 px-4 rounded-xl disabled:opacity-30 transition-all" disabled>
                üìê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà
            </button>
            <button id="clear-btn" class="w-full bg-gray-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-xl transition-all">
                üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            </button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('path-canvas'), ctx = canvas.getContext('2d');
        let recordedPoints = [], watchId = null, currentPos = null;
        let posHistory = []; // ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡∏ô‡∏¥‡πà‡∏á‡∏Ç‡∏∂‡πâ‡∏ô

        function toggleGPS() {
            const btn = document.getElementById('toggle-gps');
            const statusText = document.getElementById('status-display');

            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null; currentPos = null;
                btn.textContent = '‡πÄ‡∏õ‡∏¥‡∏î GPS'; btn.classList.replace('bg-red-600', 'bg-blue-600');
                statusText.textContent = '‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà'; statusText.classList.replace('text-emerald-400', 'text-red-400');
                document.getElementById('record-btn').disabled = true;
            } else {
                btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
                watchId = navigator.geolocation.watchPosition(updateLocation, 
                    (err) => alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á GPS ‡πÑ‡∏î‡πâ: " + err.message), 
                    { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
            }
        }

        function updateLocation(pos) {
            const acc = pos.coords.accuracy;
            document.getElementById('accuracy-display').textContent = `‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥: ${acc.toFixed(1)} ‡πÄ‡∏°‡∏ï‡∏£`;
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ó‡∏µ‡πà‡πÅ‡∏¢‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡πÄ‡∏°‡∏ï‡∏£) ‡∏≠‡∏≠‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡πÄ‡∏ö‡∏µ‡πâ‡∏¢‡∏ß
            if (acc > 30) {
                document.getElementById('status-display').textContent = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡πà‡∏≠‡∏ô';
                document.getElementById('status-display').className = 'font-bold text-orange-400';
                return;
            }

            // ‡∏£‡∏∞‡∏ö‡∏ö Smoothing (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á)
            posHistory.push({lat: pos.coords.latitude, lon: pos.coords.longitude});
            if(posHistory.length > 3) posHistory.shift();
            const avgLat = posHistory.reduce((a,b) => a + b.lat, 0) / posHistory.length;
            const avgLon = posHistory.reduce((a,b) => a + b.lon, 0) / posHistory.length;

            currentPos = { lat: avgLat, lon: avgLon };
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            const statusText = document.getElementById('status-display');
            statusText.textContent = '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå';
            statusText.className = 'font-bold text-emerald-400';
            document.getElementById('coords-display').textContent = `Lat: ${avgLat.toFixed(6)} , Lon: ${avgLon.toFixed(6)}`;
            document.getElementById('toggle-gps').textContent = '‡∏õ‡∏¥‡∏î GPS';
            document.getElementById('toggle-gps').classList.add('bg-red-600');
            document.getElementById('record-btn').disabled = false;
            
            draw();
        }

        function recordPoint() {
            if (!currentPos) return;
            recordedPoints.push({...currentPos});
            document.getElementById('point-count').textContent = recordedPoints.length;
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÅ‡∏ö‡∏ö‡∏¢‡πà‡∏≠
            const list = document.getElementById('points-list');
            if(recordedPoints.length === 1) list.innerHTML = '';
            const item = document.createElement('div');
            item.textContent = `#${recordedPoints.length}: ${currentPos.lat.toFixed(5)}, ${currentPos.lon.toFixed(5)}`;
            list.appendChild(item);
            list.scrollTop = list.scrollHeight;

            document.getElementById('calculate-btn').disabled = recordedPoints.length < 3;
            draw();
        }

        function projectToMeters(pts) {
            if (pts.length === 0) return [];
            const R = 6371000;
            const lat0 = pts[0].lat * Math.PI / 180;
            const lon0 = pts[0].lon * Math.PI / 180;
            return pts.map(p => ({
                x: (p.lon * Math.PI / 180 - lon0) * R * Math.cos(lat0),
                y: (p.lat * Math.PI / 180 - lat0) * R
            }));
        }

        function draw(isCalculated = false) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let all = [...recordedPoints];
            if(currentPos) all.push(currentPos);
            const proj = projectToMeters(all);
            if (proj.length === 0) return;

            // Auto-scaling ‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏π‡∏õ‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡πÄ‡∏™‡∏°‡∏≠
            const xs = proj.map(p => p.x), ys = proj.map(p => p.y);
            const minX = Math.min(...xs), maxX = Math.max(...xs);
            const minY = Math.min(...ys), maxY = Math.max(...ys);
            const scale = Math.min(320 / (maxX - minX || 1), 220 / (maxY - minY || 1));

            ctx.save();
            ctx.translate(canvas.width/2 - ((minX+maxX)/2)*scale, canvas.height/2 + ((minY+maxY)/2)*scale);
            
            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
            ctx.beginPath();
            proj.forEach((p, i) => {
                if(i < recordedPoints.length) i === 0 ? ctx.moveTo(p.x*scale, -p.y*scale) : ctx.lineTo(p.x*scale, -p.y*scale);
            });
            
            if(isCalculated) {
                ctx.closePath();
                ctx.fillStyle = 'rgba(59, 130, 246, 0.3)';
                ctx.fill();
            }
            
            ctx.strokeStyle = '#60a5fa';
            ctx.lineWidth = 2;
            ctx.setLineDash(isCalculated ? [] : [5, 5]);
            ctx.stroke();

            // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏ï‡πà‡∏≤‡∏á‡πÜ
            proj.forEach((p, i) => {
                ctx.setLineDash([]);
                ctx.beginPath();
                ctx.arc(p.x*scale, -p.y*scale, (i === all.length-1) ? 6 : 4, 0, 7);
                if (i === 0) ctx.fillStyle = '#10b981'; // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°
                else if (i === all.length-1) ctx.fillStyle = '#ef4444'; // ‡∏à‡∏∏‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
                else ctx.fillStyle = '#facc15'; // ‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                ctx.fill();
            });
            ctx.restore();
        }

        function calculateArea() {
            const proj = projectToMeters(recordedPoints);
            let area = 0;
            for (let i = 0; i < proj.length; i++) {
                let j = (i + 1) % proj.length;
                area += proj[i].x * proj[j].y - proj[j].x * proj[i].y;
            }
            area = Math.abs(area / 2);
            
            const wa = area / 4;
            const rai = Math.floor(wa / 400);
            const ngan = Math.floor((wa % 400) / 100);
            const sqWa = (wa % 100).toFixed(1);

            document.getElementById('result-display').innerHTML = `
                <div>
                    <p class="text-2xl font-bold text-emerald-400">${area.toLocaleString(undefined, {maximumFractionDigits:2})} <span class="text-xs text-white">‡∏ï‡∏£.‡∏°.</span></p>
                    <p class="text-blue-300 font-semibold">${rai} ‡πÑ‡∏£‡πà ${ngan} ‡∏á‡∏≤‡∏ô ${sqWa} ‡∏ï‡∏£.‡∏ß.</p>
                </div>
            `;
            draw(true);
        }

        document.getElementById('toggle-gps').onclick = toggleGPS;
        document.getElementById('record-btn').onclick = recordPoint;
        document.getElementById('calculate-btn').onclick = calculateArea;
        document.getElementById('clear-btn').onclick = () => location.reload();
    </script>
</body>
</html>
