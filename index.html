<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Area Master - Ultimate Full Function</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&family=Inter:wght@400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; }
        .accuracy-bar { transition: width 0.3s ease, background-color 0.3s ease; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        @keyframes pulse-red { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.3); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        .current-pos-marker { animation: pulse-red 1.5s infinite; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-4 flex flex-col items-center">

    <div class="w-full max-w-md space-y-4">
        <div class="bg-gray-800 p-6 rounded-3xl shadow-xl border border-gray-700">
            <h1 class="text-2xl font-bold text-blue-400 text-center">üõ∞Ô∏è GPS Area Master PRO</h1>
            <p class="text-gray-400 text-[10px] text-center mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏¢‡∏≥‡∏™‡∏π‡∏á (Hybrid + Smoothing)</p>

            <div class="bg-black/40 p-4 rounded-2xl border border-gray-600 mb-4 space-y-2">
                <div class="flex justify-between items-center">
                    <span id="status-display" class="font-bold text-red-400 text-sm">GPS ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</span>
                    <span id="accuracy-text" class="text-[10px] font-mono text-gray-400">Accuracy: -- m</span>
                </div>
                <div class="w-full bg-gray-700 h-1.5 rounded-full overflow-hidden">
                    <div id="accuracy-bar" class="accuracy-bar h-full w-0 bg-red-500"></div>
                </div>
                <div class="text-[10px] font-mono text-blue-300 text-center bg-black/20 py-1 rounded-lg" id="coords-display">
                    Lat: --- , Lon: ---
                </div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button id="toggle-gps" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95">
                    ‡πÄ‡∏õ‡∏¥‡∏î GPS
                </button>
                <button id="record-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg disabled:opacity-30 transition-all active:scale-95 flex flex-col items-center justify-center" disabled>
                    <span>üìç ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î</span>
                    <span id="sampling-status" class="text-[9px] mt-1 opacity-80 font-normal">‡∏£‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏ô‡∏¥‡πà‡∏á</span>
                </button>
            </div>
        </div>

        <div class="bg-gray-800 p-5 rounded-3xl shadow-xl border border-gray-700">
            <div class="flex justify-between items-center mb-3">
                <h2 class="font-bold text-indigo-400 text-sm">üìù ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î (‡∏•‡∏ö/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</h2>
                <button id="add-manual-row" class="bg-indigo-600 hover:bg-indigo-500 w-7 h-7 rounded-full flex items-center justify-center shadow-lg transition-transform active:scale-90">
                    <span class="text-lg font-bold">+</span>
                </button>
            </div>

            <div id="points-container" class="max-h-40 overflow-y-auto space-y-2 pr-1 custom-scrollbar">
                </div>
            
            <div class="flex gap-2 mt-4">
                <button id="undo-btn" class="flex-1 bg-amber-600 hover:bg-amber-500 text-white py-2 rounded-lg text-xs font-semibold disabled:opacity-30">‚Ü©Ô∏è ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö</button>
                <button id="clear-btn" class="flex-1 bg-gray-700 hover:bg-red-900 text-white py-2 rounded-lg text-xs font-semibold">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            </div>
        </div>

        <div class="bg-gray-800 p-5 rounded-3xl shadow-xl border border-blue-500/30 space-y-4">
            <div class="relative bg-gray-950 rounded-2xl overflow-hidden aspect-video border border-gray-700">
                <canvas id="path-canvas" width="400" height="225" class="w-full h-full"></canvas>
                <div class="absolute bottom-2 left-2 flex flex-col gap-1">
                    <span class="text-[9px] bg-black/60 px-2 py-0.5 rounded text-green-400">‚óè ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
                    <span class="text-[9px] bg-black/60 px-2 py-0.5 rounded text-red-500">‚óè ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</span>
                </div>
                <div id="dist-tag" class="absolute top-2 right-2 bg-black/60 text-[9px] px-2 py-1 rounded text-yellow-400 border border-yellow-500/30">‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ: 0 m</div>
            </div>

            <div id="result-display" class="text-center p-4 bg-gradient-to-br from-indigo-900/30 to-blue-900/30 rounded-2xl border border-blue-500/20 min-h-[70px] flex items-center justify-center">
                <p class="text-gray-500 text-xs italic">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏à‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</p>
            </div>

            <button id="calculate-btn" class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-4 rounded-2xl shadow-xl disabled:opacity-30 transition-all uppercase tracking-wider text-sm">
                üìê ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (Spherical Matrix)
            </button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('path-canvas'), ctx = canvas.getContext('2d');
        let watchId = null, currentPos = null, isSampling = false;
        let points = []; 
        let posHistory = []; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö Smoothing (‡∏à‡∏≤‡∏Å v1)

        // --- 1. ‡∏£‡∏∞‡∏ö‡∏ö GPS & Smoothing (‡∏£‡∏ß‡∏° v1 + v2) ---
        function updateLocation(pos) {
            const { latitude, longitude, accuracy } = pos.coords;
            
            // ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡πà‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å v1)
            if (accuracy > 30) {
                document.getElementById('status-display').textContent = '‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡πà‡∏≠‡∏ô‡∏°‡∏≤‡∏Å';
                document.getElementById('status-display').className = 'font-bold text-orange-500 text-sm';
                return;
            }

            // ‡∏£‡∏∞‡∏ö‡∏ö Smoothing (‡∏à‡∏≤‡∏Å v1)
            posHistory.push({lat: latitude, lon: longitude});
            if(posHistory.length > 3) posHistory.shift();
            const avgLat = posHistory.reduce((a,b) => a + b.lat, 0) / posHistory.length;
            const avgLon = posHistory.reduce((a,b) => a + b.lon, 0) / posHistory.length;
            currentPos = { lat: avgLat, lon: avgLon };

            // UI Accuracy (‡∏à‡∏≤‡∏Å v2)
            const bar = document.getElementById('accuracy-bar');
            const text = document.getElementById('accuracy-text');
            const status = document.getElementById('status-display');
            text.textContent = `Accuracy: ${accuracy.toFixed(1)} m`;
            let width = Math.max(5, 100 - (accuracy * 2));
            bar.style.width = `${width}%`;

            if (accuracy <= 10) {
                bar.className = 'h-full bg-emerald-500 transition-all';
                status.className = 'font-bold text-emerald-400 text-sm';
                status.textContent = '‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£)';
            } else {
                bar.className = 'h-full bg-yellow-500 transition-all';
                status.className = 'font-bold text-yellow-400 text-sm';
                status.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
            }

            document.getElementById('coords-display').textContent = `Lat: ${avgLat.toFixed(6)}, Lon: ${avgLon.toFixed(6)}`;
            document.getElementById('record-btn').disabled = false;
            draw();
        }

        // --- 2. Multi-Sampling Record (‡∏à‡∏≤‡∏Å v2) ---
        async function recordWithSampling() {
            if (!currentPos || isSampling) return;
            isSampling = true;
            const statusText = document.getElementById('sampling-status');
            
            for (let i = 1; i <= 5; i++) {
                statusText.textContent = `‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á (${i}/5)...`;
                if (window.navigator.vibrate) window.navigator.vibrate(30); // ‡∏™‡∏±‡πà‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö (v2)
                await new Promise(r => setTimeout(r, 250));
            }

            points.push({...currentPos});
            isSampling = false;
            statusText.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
            renderPointsList();
            if (window.navigator.vibrate) window.navigator.vibrate([50, 30, 50]); // ‡∏™‡∏±‡πà‡∏ô‡∏à‡∏ö (v2)
        }

        // --- 3. UI Management (‡∏à‡∏≤‡∏Å v3) ---
        function renderPointsList() {
            const container = document.getElementById('points-container');
            container.innerHTML = '';
            points.forEach((p, index) => {
                const div = document.createElement('div');
                div.className = 'flex gap-2 items-center bg-gray-700/30 p-2 rounded-lg border border-gray-700';
                div.innerHTML = `
                    <span class="text-[9px] text-gray-500 w-4">${index + 1}</span>
                    <input type="number" step="any" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-[10px] outline-none" value="${p.lat.toFixed(6)}" oninput="points[${index}].lat = parseFloat(this.value); draw();">
                    <input type="number" step="any" class="w-full bg-gray-900 border border-gray-600 rounded px-2 py-1 text-[10px] outline-none" value="${p.lon.toFixed(6)}" oninput="points[${index}].lon = parseFloat(this.value); draw();">
                    <button onclick="points.splice(${index}, 1); renderPointsList();" class="text-red-500 px-1 text-xs">‚úï</button>
                `;
                container.appendChild(div);
            });
            document.getElementById('calculate-btn').disabled = points.length < 3;
            document.getElementById('undo-btn').disabled = points.length === 0;
            draw();
        }

        // --- 4. Drawing & Calculation (‡∏£‡∏ß‡∏°‡∏ó‡∏∏‡∏Å v) ---
        function draw(isCalculated = false) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let all = [...points];
            if (currentPos && watchId && !isCalculated) all.push(currentPos);
            if (all.length === 0) return;

            const R = 6371000;
            const lat0 = all[0].lat * Math.PI / 180, lon0 = all[0].lon * Math.PI / 180;
            const proj = all.map(p => ({
                x: (p.lon * Math.PI / 180 - lon0) * R * Math.cos(lat0),
                y: (p.lat * Math.PI / 180 - lat0) * R
            }));

            const xs = proj.map(p => p.x), ys = proj.map(p => p.y);
            const minX = Math.min(...xs), maxX = Math.max(...xs), minY = Math.min(...ys), maxY = Math.max(...ys);
            const scale = Math.min(340 / (maxX - minX || 1), 180 / (maxY - minY || 1));

            ctx.save();
            ctx.translate(canvas.width/2 - ((minX+maxX)/2)*scale, canvas.height/2 + ((minY+maxY)/2)*scale);
            
            // ‡∏ß‡∏≤‡∏î‡πÄ‡∏™‡πâ‡∏ô (‡∏à‡∏≤‡∏Å v1)
            ctx.beginPath();
            proj.forEach((p, i) => {
                const isRealPoint = i < points.length;
                if(isRealPoint || (currentPos && watchId)) {
                    i === 0 ? ctx.moveTo(p.x*scale, -p.y*scale) : ctx.lineTo(p.x*scale, -p.y*scale);
                }
            });
            
            if(isCalculated) {
                ctx.closePath();
                ctx.fillStyle = 'rgba(79, 70, 229, 0.4)';
                ctx.fill();
                ctx.setLineDash([]);
            } else {
                ctx.setLineDash([5, 5]); // ‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏Ç‡∏ì‡∏∞‡∏ß‡∏±‡∏î (v1)
            }
            ctx.strokeStyle = '#4f46e5'; ctx.lineWidth = 3; ctx.stroke();

            // ‡∏ß‡∏≤‡∏î‡∏à‡∏∏‡∏î (‡∏à‡∏≤‡∏Å v1)
            proj.forEach((p, i) => {
                ctx.setLineDash([]);
                ctx.beginPath();
                // ‡∏à‡∏∏‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ (v1)
                const isLast = (i === all.length-1 && currentPos && !isCalculated);
                ctx.arc(p.x*scale, -p.y*scale, isLast ? 6 : 4, 0, 7);
                
                if (i === 0) ctx.fillStyle = '#10b981'; // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏° (v1)
                else if (isLast) ctx.fillStyle = '#ef4444'; // ‡∏à‡∏∏‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (v1)
                else ctx.fillStyle = '#facc15'; // ‡∏à‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å (v1)
                
                ctx.fill();
                ctx.strokeStyle = "white"; ctx.lineWidth = 1; ctx.stroke();
            });
            ctx.restore();

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ (‡∏à‡∏≤‡∏Å v2)
            let dist = 0;
            for(let i=0; i<points.length-1; i++) dist += getDist(points[i], points[i+1]);
            if(points.length > 2) dist += getDist(points[points.length-1], points[0]);
            document.getElementById('dist-tag').textContent = `‡∏£‡∏≠‡∏ö‡∏£‡∏π‡∏õ: ${dist.toFixed(1)} m`;
        }

        function getDist(p1, p2) {
            const R = 6371e3;
            const dLat = (p2.lat-p1.lat)*Math.PI/180, dLon = (p2.lon-p1.lon)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(p1.lat*Math.PI/180)*Math.cos(p2.lat*Math.PI/180)*Math.sin(dLon/2)**2;
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function calculateArea() {
            const R = 6371000;
            let area = 0;
            for (let i = 0; i < points.length; i++) {
                let p1 = points[i], p2 = points[(i+1)%points.length];
                area += (p2.lon - p1.lon) * Math.PI / 180 * (2 + Math.sin(p1.lat*Math.PI/180) + Math.sin(p2.lat*Math.PI/180));
            }
            area = Math.abs(area * R * R / 2);
            const wa = area / 4;
            const r = Math.floor(wa/400), n = Math.floor((wa%400)/100), w = (wa%100).toFixed(1);
            document.getElementById('result-display').innerHTML = `<div><p class="text-2xl font-black text-emerald-400">${area.toLocaleString()} ‡∏ï‡∏£.‡∏°.</p><p class="text-blue-300 font-bold text-sm">${r} ‡πÑ‡∏£‡πà ${n} ‡∏á‡∏≤‡∏ô ${w} ‡∏ï‡∏£.‡∏ß.</p></div>`;
            draw(true);
        }

        // --- Event Listeners ---
        document.getElementById('toggle-gps').onclick = function() {
            if(watchId) { navigator.geolocation.clearWatch(watchId); watchId = null; this.textContent = "‡πÄ‡∏õ‡∏¥‡∏î GPS"; this.className="bg-blue-600 font-bold py-3 rounded-xl w-full"; }
            else { watchId = navigator.geolocation.watchPosition(updateLocation, (e)=>alert(e.message), {enableHighAccuracy:true}); this.textContent = "‡∏õ‡∏¥‡∏î GPS"; this.className="bg-red-600 font-bold py-3 rounded-xl w-full"; }
        };
        document.getElementById('record-btn').onclick = recordWithSampling;
        document.getElementById('add-manual-row').onclick = () => { points.push({lat:0, lon:0}); renderPointsList(); };
        document.getElementById('undo-btn').onclick = () => { points.pop(); renderPointsList(); };
        document.getElementById('clear-btn').onclick = () => { if(confirm('‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) location.reload(); };
        document.getElementById('calculate-btn').onclick = calculateArea;
        
        // Initial Empty Rows (v3)
        for(let i=0; i<3; i++) points.push({lat:0, lon:0});
        renderPointsList();
    </script>
</body>
</html>
