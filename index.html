<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPS Area Precision - Google Style</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600&display=swap');
        body { font-family: 'Prompt', sans-serif; background-color: #0b0d0f; }
        .map-container { position: relative; overflow: hidden; border-radius: 1.5rem; }
        #map-bg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; opacity: 0.5; z-index: 0; }
        canvas { position: relative; z-index: 10; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
    </style>
</head>
<body class="text-slate-200 min-h-screen flex flex-col items-center p-4">

    <div class="w-full max-w-md space-y-4">
        <!-- Header -->
        <div class="flex items-center justify-between px-2">
            <div>
                <h1 class="text-xl font-semibold text-white flex items-center gap-2">
                    <span class="text-blue-500">●</span> Google Precision Mode
                </h1>
                <p class="text-[10px] text-slate-400 uppercase tracking-tighter">Fused Location Data Engine</p>
            </div>
            <div id="connection-dot" class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></div>
        </div>

        <!-- Satellite View Area -->
        <div class="map-container glass-panel h-64 shadow-2xl border-2 border-slate-700">
            <!-- Simulated Satellite Background (จะเปลี่ยนตามพิกัดจริง) -->
            <img id="map-bg" src="https://images.unsplash.com/photo-1526778548025-fa2f459cd5c1?auto=format&fit=crop&w=800&q=80" alt="Satellite View">
            <canvas id="main-canvas" class="w-full h-full"></canvas>
            
            <!-- Floating Data -->
            <div class="absolute bottom-3 left-3 z-20 glass-panel p-2 rounded-lg text-[10px]">
                <div id="live-lat">LAT: 0.00000000</div>
                <div id="live-lon">LON: 0.00000000</div>
            </div>
            <div id="accuracy-badge" class="absolute top-3 right-3 z-20 bg-blue-600 text-white text-[9px] px-2 py-1 rounded-full font-bold">
                SIGNAL: SEARCHING...
            </div>
        </div>

        <!-- Status & Controls -->
        <div class="glass-panel rounded-3xl p-5 space-y-4">
            <div class="flex justify-between items-center border-b border-slate-700 pb-3">
                <span class="text-xs text-slate-400">ความแม่นยำขณะนี้</span>
                <span id="acc-text" class="text-lg font-mono text-emerald-400">-- m</span>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button id="toggle-btn" class="py-4 rounded-2xl bg-white text-slate-900 font-bold text-sm transition-all active:scale-95">เริ่มดึงสัญญาณ</button>
                <button id="record-btn" disabled class="py-4 rounded-2xl bg-blue-600 text-white font-bold text-sm disabled:opacity-30 transition-all active:scale-95">บันทึกจุด (0.5m)</button>
            </div>
        </div>

        <!-- Area Result -->
        <div class="glass-panel rounded-3xl p-6 text-center relative overflow-hidden">
            <div class="relative z-10">
                <h3 class="text-xs text-slate-400 mb-1">คำนวณพื้นที่สุทธิ</h3>
                <div id="area-val" class="text-3xl font-bold text-white">0.00 <span class="text-sm font-normal text-slate-500">ตร.ม.</span></div>
                <div id="thai-unit" class="text-xs text-blue-400 mt-1">0 ไร่ 0 งาน 0 ตร.ว.</div>
            </div>
            <div class="absolute top-0 right-0 p-2 opacity-10">
                <svg width="60" height="60" viewBox="0 0 24 24"><path fill="currentColor" d="M15,5H9V3H15M15,19H9V21H15M13,11V9H11V11H9V13H11V15H13V13H15V11M18,1H6A2,2 0 0,0 4,3V21A2,2 0 0,0 6,23H18A2,2 0 0,0 20,21V3A2,2 0 0,0 18,1Z"/></svg>
            </div>
        </div>

        <!-- Footer Actions -->
        <div class="flex gap-2">
            <button id="calc-btn" disabled class="flex-1 py-3 glass-panel rounded-xl text-xs font-semibold hover:bg-slate-700">ประมวลผลพื้นที่</button>
            <button id="clear-btn" class="px-6 py-3 glass-panel rounded-xl text-xs font-semibold text-red-400">ล้าง</button>
        </div>
    </div>

    <script>
        // --- Core Configuration ---
        const config = {
            targetAccuracy: 0.5,
            bufferSize: 8, // เพิ่มขนาด buffer เพื่อความเนียนระดับ Google
            googleMapKey: '' // หากมี API Key สามารถใส่ได้เพื่อให้เป็นแผนที่จริง
        };

        let state = {
            active: false,
            points: [],
            currentPos: null,
            buffer: [],
            watchId: null
        };

        const canvas = document.getElementById('main-canvas');
        const ctx = canvas.getContext('2d');
        const mapBg = document.getElementById('map-bg');

        function init() {
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();
            setupEventListeners();
        }

        function resizeCanvas() {
            canvas.width = canvas.offsetWidth;
            canvas.height = canvas.offsetHeight;
            draw();
        }

        function setupEventListeners() {
            document.getElementById('toggle-btn').onclick = toggleGPS;
            document.getElementById('record-btn').onclick = recordPoint;
            document.getElementById('calc-btn').onclick = calculateArea;
            document.getElementById('clear-btn').onclick = clearData;
        }

        function toggleGPS() {
            const btn = document.getElementById('toggle-btn');
            const dot = document.getElementById('connection-dot');

            if (state.active) {
                navigator.geolocation.clearWatch(state.watchId);
                state.active = false;
                btn.textContent = "เริ่มดึงสัญญาณ";
                btn.className = "py-4 rounded-2xl bg-white text-slate-900 font-bold text-sm";
                dot.className = "w-3 h-3 rounded-full bg-red-500 animate-pulse";
            } else {
                state.active = true;
                btn.textContent = "หยุดดึงสัญญาณ";
                btn.className = "py-4 rounded-2xl bg-slate-700 text-white font-bold text-sm";
                dot.className = "w-3 h-3 rounded-full bg-emerald-500 animate-pulse";
                
                state.watchId = navigator.geolocation.watchPosition(
                    handlePos, 
                    (err) => console.error(err), 
                    { enableHighAccuracy: true, maximumAge: 0 }
                );
            }
        }

        function handlePos(pos) {
            // Fused Logic Simulation: กรองสัญญาณและทำ Moving Average
            state.buffer.push({
                lat: pos.coords.latitude,
                lon: pos.coords.longitude,
                acc: pos.coords.accuracy
            });
            if (state.buffer.length > config.bufferSize) state.buffer.shift();

            const avgLat = state.buffer.reduce((a, b) => a + b.lat, 0) / state.buffer.length;
            const avgLon = state.buffer.reduce((a, b) => a + b.lon, 0) / state.buffer.length;
            const avgAcc = state.buffer.reduce((a, b) => a + b.acc, 0) / state.buffer.length;

            state.currentPos = { lat: avgLat, lon: avgLon, acc: avgAcc };

            updateUI(avgAcc);
            draw();
            
            // อัปเดตพื้นหลังดาวเทียม (จำลองพิกัดจริง)
            // ในแอปจริงควรใช้ Google Static Maps API ที่นี่
            // mapBg.src = `https://maps.googleapis.com/maps/api/staticmap?center=${avgLat},${avgLon}&zoom=19&size=600x600&maptype=satellite&key=YOUR_KEY`;
        }

        function updateUI(acc) {
            document.getElementById('acc-text').textContent = acc.toFixed(2) + " m";
            document.getElementById('live-lat').textContent = `LAT: ${state.currentPos.lat.toFixed(8)}`;
            document.getElementById('live-lon').textContent = `LON: ${state.currentPos.lon.toFixed(8)}`;
            
            const badge = document.getElementById('accuracy-badge');
            const recordBtn = document.getElementById('record-btn');
            
            if (acc <= config.targetAccuracy) {
                badge.textContent = "PRECISION: OPTIMAL";
                badge.className = "absolute top-3 right-3 z-20 bg-emerald-600 text-white text-[9px] px-2 py-1 rounded-full font-bold shadow-lg";
            } else {
                badge.textContent = "PRECISION: STABILIZING...";
                badge.className = "absolute top-3 right-3 z-20 bg-amber-500 text-white text-[9px] px-2 py-1 rounded-full font-bold";
            }
            
            recordBtn.disabled = !state.active;
            document.getElementById('calc-btn').disabled = state.points.length < 3;
        }

        function recordPoint() {
            if (!state.currentPos) return;
            state.points.push({...state.currentPos});
            draw();
            updateUI(state.currentPos.acc);
        }

        function calculateArea() {
            if (state.points.length < 3) return;
            
            // ใช้ Shoelace Formula บนระบบพิกัด UTM จำลอง
            const R = 6371000;
            const lat0 = state.points[0].lat * Math.PI / 180;
            const lon0 = state.points[0].lon * Math.PI / 180;
            const cosLat0 = Math.cos(lat0);

            const pts = state.points.map(p => ({
                x: (p.lon * Math.PI / 180 - lon0) * R * cosLat0,
                y: (p.lat * Math.PI / 180 - lat0) * R
            }));

            let area = 0;
            for (let i = 0; i < pts.length; i++) {
                let j = (i + 1) % pts.length;
                area += pts[i].x * pts[j].y;
                area -= pts[j].x * pts[i].y;
            }
            area = Math.abs(area) / 2;

            document.getElementById('area-val').innerHTML = `${area.toFixed(2)} <span class="text-sm font-normal text-slate-500">ตร.ม.</span>`;
            
            const rai = Math.floor(area / 1600);
            const ngan = Math.floor((area % 1600) / 400);
            const wa = (area % 400) / 4;
            document.getElementById('thai-unit').textContent = `${rai} ไร่ ${ngan} งาน ${wa.toFixed(2)} ตร.ว.`;
        }

        function clearData() {
            state.points = [];
            state.buffer = [];
            document.getElementById('area-val').innerHTML = `0.00 <span class="text-sm font-normal text-slate-500">ตร.ม.</span>`;
            document.getElementById('thai-unit').textContent = `0 ไร่ 0 งาน 0 ตร.ว.`;
            draw();
            updateUI(0);
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const all = [...state.points];
            if (state.currentPos) all.push(state.currentPos);
            if (all.length === 0) return;

            // หา Scale ให้เหมาะกับหน้าจอ
            const lats = all.map(p => p.lat);
            const lons = all.map(p => p.lon);
            const minLat = Math.min(...lats), maxLat = Math.max(...lats);
            const minLon = Math.min(...lons), maxLon = Math.max(...lons);
            
            const padding = 50;
            const scaleX = (canvas.width - padding * 2) / (maxLon - minLon || 0.00001);
            const scaleY = (canvas.height - padding * 2) / (maxLat - minLat || 0.00001);
            const scale = Math.min(scaleX, scaleY);

            const getX = (lon) => canvas.width/2 + (lon - (minLon + maxLon)/2) * scale;
            const getY = (lat) => canvas.height/2 - (lat - (minLat + maxLat)/2) * scale;

            // วาดเส้นทาง
            if (state.points.length > 1) {
                ctx.beginPath();
                ctx.strokeStyle = "rgba(59, 130, 246, 1)";
                ctx.lineWidth = 3;
                ctx.setLineDash([]);
                state.points.forEach((p, i) => {
                    i === 0 ? ctx.moveTo(getX(p.lon), getY(p.lat)) : ctx.lineTo(getX(p.lon), getY(p.lat));
                });
                ctx.stroke();
            }

            // วาดจุดที่บันทึก
            state.points.forEach((p, i) => {
                ctx.beginPath();
                ctx.arc(getX(p.lon), getY(p.lat), 6, 0, Math.PI*2);
                ctx.fillStyle = i === 0 ? "#10b981" : "#3b82f6";
                ctx.fill();
                ctx.strokeStyle = "white";
                ctx.lineWidth = 2;
                ctx.stroke();
            });

            // วาดจุดปัจจุบัน (Crosshair Style แบบ Google)
            if (state.currentPos) {
                const cx = getX(state.currentPos.lon);
                const cy = getY(state.currentPos.lat);
                
                // วาดรัศมี Accuracy
                ctx.beginPath();
                ctx.arc(cx, cy, Math.max(10, state.currentPos.acc * 2), 0, Math.PI*2);
                ctx.fillStyle = "rgba(59, 130, 246, 0.2)";
                ctx.fill();

                ctx.beginPath();
                ctx.arc(cx, cy, 8, 0, Math.PI*2);
                ctx.fillStyle = "white";
                ctx.fill();
                ctx.beginPath();
                ctx.arc(cx, cy, 5, 0, Math.PI*2);
                ctx.fillStyle = "#3b82f6";
                ctx.fill();
            }
        }

        init();
    </script>
</body>
</html>

